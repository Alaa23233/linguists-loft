<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linguist's Loft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #f8fafc; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .btn-press:active { transform: scale(0.95); }
    </style>
</head>
<body class="text-slate-800">

    <!-- DESKTOP SIDEBAR -->
    <aside class="hidden md:flex flex-col w-64 bg-white border-r border-slate-200 p-4 fixed h-full z-10 left-0 top-0">
        <div class="flex items-center gap-3 px-2 mb-8 mt-2">
            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg">L</div>
            <div>
                <h1 class="font-bold text-lg leading-none text-slate-900">Linguist's Loft</h1>
                <span class="text-xs font-semibold text-indigo-500 uppercase tracking-wider">Year 3 Ed.</span>
            </div>
        </div>
        <nav class="flex-1 space-y-2" id="desktop-nav"></nav>
        <div class="mt-auto pt-6 border-t border-slate-100">
            <button onclick="router('settings')" class="flex items-center gap-2 text-slate-400 hover:text-indigo-600 transition-colors text-sm px-2 w-full text-left font-medium">
                <i data-lucide="settings" width="16"></i> App Settings
            </button>
        </div>
    </aside>

    <!-- MOBILE HEADER -->
    <div class="md:hidden fixed top-0 w-full bg-white/90 backdrop-blur-md z-50 border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold">L</div>
            <span class="font-bold text-lg text-indigo-900 tracking-tight">Linguist's Loft</span>
        </div>
        <div class="flex items-center gap-3">
            <div id="xp-badge" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold">0 XP</div>
            
            <!-- MOBILE SETTINGS BUTTON (Purple & High Contrast) -->
            <button onclick="router('settings')" class="bg-indigo-50 p-2 rounded-full text-indigo-600 hover:bg-indigo-100 transition-all border border-indigo-100 shadow-sm active:scale-90">
                <!-- Hardcoded SVG Settings Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main id="app-root" class="flex-1 md:ml-64 p-4 md:p-8 pt-20 md:pt-8 pb-24 md:pb-8 max-w-5xl mx-auto min-h-screen">
        <!-- Views rendered here by JS -->
    </main>

    <!-- NOTIFICATION TOAST -->
    <div id="notification" class="fixed top-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl z-[100] flex items-center gap-3 transition-all duration-300 transform -translate-y-20 opacity-0 pointer-events-none">
        <i data-lucide="sparkles" class="text-amber-400 w-4 h-4"></i>
        <span id="notif-text" class="font-medium text-sm"></span>
    </div>

    <!-- MOBILE NAV -->
    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 flex justify-around p-2 z-40 safe-area-pb" id="mobile-nav">
        <!-- Mobile nav items rendered by JS -->
    </nav>

    <script>
        // --- STATE MANAGEMENT ---
        const state = {
            view: 'dashboard',
            apiKey: localStorage.getItem('gemini_api_key') || '',
            customName: localStorage.getItem('user_name') || "Alaa's Star",
            cheerMessage: localStorage.getItem('cheer_msg') || "Keep shining! ‚ú®",
            xp: parseInt(localStorage.getItem('user_xp') || '0'),
            savedWords: JSON.parse(localStorage.getItem('saved_words') || '[]'),
            chatHistory: [{ role: 'assistant', text: 'Na? Everything okay? Tell me the gossip! ‚òï' }],
            materialText: '',
            analyzedContent: null,
            transInput: '',
            transPrompt: null,
            transFeedback: null,
            funContent: null,
            loading: false
        };

        // --- CORE FUNCTIONS ---
        function saveState() {
            localStorage.setItem('gemini_api_key', state.apiKey);
            localStorage.setItem('user_name', state.customName);
            localStorage.setItem('cheer_msg', state.cheerMessage);
            localStorage.setItem('user_xp', state.xp);
            localStorage.setItem('saved_words', JSON.stringify(state.savedWords));
            updateUI();
        }

        function addXP(amount) {
            state.xp += amount;
            showNotification(`+${amount} XP! Super!`);
            saveState();
        }

        function showNotification(msg) {
            const el = document.getElementById('notification');
            const txt = document.getElementById('notif-text');
            txt.innerText = msg;
            el.classList.remove('-translate-y-20', 'opacity-0');
            lucide.createIcons();
            setTimeout(() => {
                el.classList.add('-translate-y-20', 'opacity-0');
            }, 3000);
        }

        function speak(text) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'de-DE';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }

        // --- API INTEGRATION ---
        async function callGemini(prompt, systemPrompt = "") {
            if (!state.apiKey) {
                showNotification("Please enter API Key in Settings first!");
                throw new Error("No API Key");
            }
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                state.loading = true;
                render(); // Show loading state
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                state.loading = false;
                render();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(text);
            } catch (error) {
                state.loading = false;
                render();
                console.error(error);
                showNotification("Connection failed. Check Settings.");
                throw error;
            }
        }

        // --- FEATURE LOGIC ---
        
        async function handleMaterialAnalyze() {
            if(!state.materialText.trim()) return showNotification("Paste text first!");
            const prompt = state.materialText;
            const sys = `You are a gentle, fun German tutor. Analyze text. Output JSON: { "summary": "B2 Summary", "vocabulary": [{"word": "German", "meaning": "English/Arabic", "type": "Noun"}], "coolConnection": "Fact linking to Arabic/English logic", "quiz": [{"id": 1, "q": "Question?", "opts": ["A","B","C"], "correct": 0, "explanation": "Why correct"}] }`;
            const res = await callGemini(prompt, sys);
            if(res) state.analyzedContent = res;
            addXP(10);
            render();
        }

        async function handleChatSend() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            state.chatHistory.push({ role: 'user', text });
            input.value = '';
            render(); // update UI immediately

            const sys = `You are a 'German Bestie'. Gossip, fun, emojis. Correct gently. Output JSON: { "reply": "German text", "correction": "Optional correction" }`;
            const context = state.chatHistory.slice(-3).map(m => `${m.role}: ${m.text}`).join('\n') + `\nUser: ${text}`;
            
            try {
                const res = await callGemini(context, sys);
                state.chatHistory.push({ role: 'assistant', text: res.reply, correction: res.correction });
                render();
            } catch(e) {}
        }

        async function handleHateGerman() {
            router('culture');
            const sys = `User hates German. Make them laugh. Options: Funny untranslatable word, weird idiom, song rec (Indie/Pop), grammar joke. Output JSON: { "title": "Did you know?", "content": "The fact/joke", "type": "fun", "emoji": "üòÇ" }`;
            const res = await callGemini("Make me laugh", sys);
            if(res) state.funContent = res;
            render();
        }

        async function handleTranslationStart() {
            const sys = `Generate C1 German sentence. Output JSON: { "text": "sentence", "context": "Literature/News" }`;
            const res = await callGemini("Generate challenge", sys);
            if(res) { state.transPrompt = res; state.transFeedback = null; state.transInput = ''; }
            render();
        }

        async function handleTranslationCheck() {
            if(!state.transInput) return;
            const prompt = `Source: "${state.transPrompt.text}" User: "${state.transInput}". Rate 0-100. Be comforting. Output JSON: { "score": 90, "feedback": "comments" }`;
            const res = await callGemini(prompt);
            if(res) {
                state.transFeedback = res;
                if(res.score > 80) addXP(50); else addXP(20);
            }
            render();
        }

        function saveWordToDeck(word, meaning, type) {
            if(state.savedWords.some(w => w.word === word)) return showNotification("Already saved!");
            state.savedWords.push({ word, meaning, type });
            saveState();
            showNotification("Saved to Deck!");
        }

        function removeWord(word) {
            state.savedWords = state.savedWords.filter(w => w.word !== word);
            saveState();
            render();
        }

        // --- ROUTING & RENDERING ---
        function router(viewName) {
            state.view = viewName;
            render();
        }

        function updateUI() {
            document.getElementById('xp-badge').innerText = `${state.xp} XP`;
        }

        function render() {
            const root = document.getElementById('app-root');
            const nav = document.getElementById('mobile-nav');
            const desktopNav = document.getElementById('desktop-nav');
            
            // Render Navigation
            const links = [
                { id: 'dashboard', icon: 'graduation-cap', label: 'Home' },
                { id: 'material', icon: 'book-open', label: 'Study' },
                { id: 'culture', icon: 'heart', label: 'Vibes' },
                { id: 'translation', icon: 'languages', label: 'Trans' },
                { id: 'chat', icon: 'message-circle', label: 'Chat' }
            ];

            // Mobile Nav HTML
            nav.innerHTML = links.map(l => `
                <button onclick="router('${l.id}')" class="p-3 rounded-2xl flex flex-col items-center gap-1 btn-press ${state.view === l.id ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400'}">
                    <i data-lucide="${l.icon}" width="22"></i>
                    <span class="text-[10px] font-bold">${l.label}</span>
                </button>
            `).join('');

            // Desktop Nav HTML
            desktopNav.innerHTML = links.map(l => `
                <button onclick="router('${l.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all btn-press ${state.view === l.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-100'}">
                    <i data-lucide="${l.icon}" width="20"></i>
                    <span class="font-semibold">${l.label}</span>
                </button>
            `).join('');

            // Helper for Loading
            if (state.loading) {
                root.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-96 animate-pulse">
                        <div class="text-6xl mb-4">ü•®</div>
                        <p class="text-slate-400 font-medium">Baking fresh German content...</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Render Views
            let html = '';

            if (state.view === 'dashboard') {
                html = `
                    <div class="space-y-8 fade-in">
                        <div class="relative bg-gradient-to-r from-indigo-600 via-purple-600 to-violet-600 rounded-3xl p-8 text-white overflow-hidden shadow-2xl shadow-indigo-200">
                            <div class="relative z-10">
                                <h2 class="text-3xl font-bold mb-2">Willkommen, ${state.customName}!</h2>
                                <p class="text-indigo-100 text-lg mb-6 max-w-lg font-medium opacity-90">"${state.cheerMessage}"</p>
                                <div class="flex flex-wrap gap-4">
                                    <div class="bg-white/20 backdrop-blur-md px-4 py-2 rounded-xl border border-white/10">
                                        <span class="block text-xs uppercase opacity-70 mb-1">Total XP</span>
                                        <span class="font-bold text-xl">${state.xp}</span>
                                    </div>
                                    <button onclick="handleHateGerman()" class="bg-pink-500 text-white px-4 py-2 rounded-xl font-bold hover:bg-pink-600 hover:scale-105 transition-all shadow-lg flex items-center gap-2 btn-press">
                                        <i data-lucide="frown" width="18"></i> I hate German right now
                                    </button>
                                </div>
                            </div>
                            <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-white opacity-10 rounded-full blur-3xl"></div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div onclick="router('flashcards')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:border-indigo-300 transition-all cursor-pointer flex flex-col items-center justify-center text-center gap-2">
                                <div class="w-12 h-12 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center mb-1">
                                    <i data-lucide="library" width="24"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-2xl">${state.savedWords.length}</div>
                                    <div class="text-xs text-slate-500 font-bold uppercase tracking-wide">Saved Words</div>
                                </div>
                            </div>
                            <div onclick="router('material')" class="col-span-2 bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:border-blue-400 transition-all cursor-pointer flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center">
                                        <i data-lucide="book-open" width="24"></i>
                                    </div>
                                    <div class="text-left">
                                        <div class="font-bold text-slate-700">Study Materials</div>
                                        <div class="text-xs text-slate-500">Analyze lecture notes</div>
                                    </div>
                                </div>
                                <i data-lucide="arrow-right" class="text-slate-300"></i>
                            </div>
                        </div>
                    </div>
                `;
            } 
            else if (state.view === 'material') {
                html = `
                    <div class="space-y-6 max-w-3xl mx-auto fade-in">
                        <div class="flex justify-between items-end mb-2">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800">Material Lab</h2>
                                <p class="text-slate-500 text-sm">Paste your lecture text for instant analysis.</p>
                            </div>
                            ${state.analyzedContent ? `<button onclick="state.analyzedContent=null;state.materialText='';render()" class="text-slate-500 flex items-center gap-1 hover:text-indigo-600"><i data-lucide="rotate-ccw" width="16"></i> Reset</button>` : ''}
                        </div>

                        ${!state.analyzedContent ? `
                            <div class="bg-white rounded-2xl shadow-xl border border-slate-100 p-1">
                                <textarea id="mat-input" class="w-full h-64 p-6 resize-none focus:outline-none text-slate-700 text-lg leading-relaxed bg-white rounded-xl" placeholder="Paste German text here..." oninput="state.materialText = this.value">${state.materialText}</textarea>
                                <div class="bg-slate-50 p-4 flex justify-end border-t border-slate-100 rounded-b-xl">
                                    <button onclick="handleMaterialAnalyze()" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg hover:shadow-xl btn-press flex items-center gap-2">
                                        <i data-lucide="sparkles" width="18"></i> Generate Study Guide
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div class="space-y-8">
                                ${state.analyzedContent.coolConnection ? `
                                    <div class="bg-gradient-to-r from-amber-100 to-yellow-50 p-6 rounded-2xl border border-amber-200">
                                        <h3 class="font-bold text-amber-900 flex items-center gap-2 mb-2"><i data-lucide="sparkles" width="18"></i> Why this is actually cool:</h3>
                                        <p class="text-amber-800 leading-relaxed">${state.analyzedContent.coolConnection}</p>
                                    </div>
                                ` : ''}
                                <div class="bg-white rounded-2xl border-l-4 border-indigo-500 shadow-sm p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <h3 class="font-bold text-lg text-indigo-900">Zusammenfassung</h3>
                                        <button onclick="speak('${state.analyzedContent.summary.replace(/'/g, "\\'")}')" class="p-2 bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-100"><i data-lucide="volume-2" width="20"></i></button>
                                    </div>
                                    <p class="text-slate-700 leading-relaxed text-lg font-serif">${state.analyzedContent.summary}</p>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    ${state.analyzedContent.vocabulary.map(v => `
                                        <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                                            <div class="flex justify-between items-start mb-1">
                                                <span class="font-bold text-slate-800 text-lg">${v.word}</span>
                                                <div class="flex gap-1">
                                                    <button onclick="speak('${v.word}')" class="text-slate-400 hover:text-indigo-600 p-1"><i data-lucide="volume-2" width="16"></i></button>
                                                    <button onclick="saveWordToDeck('${v.word}', '${v.meaning}', '${v.type}')" class="text-slate-400 hover:text-amber-500 p-1"><i data-lucide="heart" width="16"></i></button>
                                                </div>
                                            </div>
                                            <span class="px-2 py-1 rounded-md text-xs font-bold bg-purple-100 text-purple-700">${v.type}</span>
                                            <p class="text-slate-600 mt-2 text-sm">${v.meaning}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `}
                    </div>
                `;
            }
            else if (state.view === 'culture') {
                html = `
                    <div class="max-w-2xl mx-auto space-y-6 fade-in">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-slate-800 mb-2 flex items-center justify-center gap-2"><i data-lucide="music" class="text-pink-500"></i> German Vibes</h2>
                            <p class="text-slate-500">Discover the fun side. No grammar allowed here.</p>
                        </div>
                        <div class="flex flex-col items-center gap-4">
                            <button onclick="handleHateGerman()" class="w-full bg-gradient-to-br from-amber-200 to-orange-100 p-6 rounded-3xl text-left hover:scale-105 transition-transform shadow-lg shadow-orange-100 border border-orange-200 btn-press">
                                <div class="mb-3 text-orange-600"><i data-lucide="zap" width="32"></i></div>
                                <h3 class="font-bold text-xl text-orange-900">Make me laugh</h3>
                                <p class="text-orange-800 text-sm opacity-80">Jokes, memes & weird words</p>
                            </button>
                        </div>
                        ${state.funContent ? `
                            <div class="bg-white rounded-2xl shadow-xl p-8 relative overflow-hidden mt-6 fade-in border border-slate-100">
                                <div class="flex items-center gap-2 mb-4 text-amber-600 font-bold uppercase tracking-wider text-xs">
                                    ${state.funContent.emoji} ${state.funContent.title}
                                </div>
                                <h3 class="text-xl font-medium text-slate-800 mb-4 leading-relaxed whitespace-pre-line">${state.funContent.content}</h3>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            else if (state.view === 'flashcards') {
                html = `
                    <div class="max-w-2xl mx-auto space-y-6 fade-in">
                        <h2 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="library" class="text-amber-500"></i> Flashcard Deck</h2>
                        ${state.savedWords.length === 0 ? `
                            <div class="text-center py-20 bg-white rounded-3xl border border-dashed border-slate-300">
                                <div class="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="save" class="text-slate-400"></i></div>
                                <h3 class="font-bold text-lg text-slate-700">Deck is Empty</h3>
                                <p class="text-slate-500 mb-6">Save words from the Material Lab to review them here.</p>
                                <button onclick="router('material')" class="bg-white border-2 border-indigo-100 text-indigo-700 px-4 py-2 rounded-xl font-bold hover:bg-indigo-50">Go to Lab</button>
                            </div>
                        ` : `
                            <div class="grid gap-4">
                                ${state.savedWords.map(w => `
                                    <div class="bg-white rounded-2xl p-4 flex items-center justify-between shadow-sm border border-slate-100">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-1">
                                                <h3 class="font-bold text-xl text-slate-800">${w.word}</h3>
                                                <span class="px-2 py-1 rounded-md text-xs font-bold bg-blue-100 text-blue-700">${w.type}</span>
                                                <button onclick="speak('${w.word}')" class="text-slate-300 hover:text-indigo-600"><i data-lucide="volume-2" width="18"></i></button>
                                            </div>
                                            <p class="text-slate-600 font-medium">${w.meaning}</p>
                                        </div>
                                        <button onclick="removeWord('${w.word}')" class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg"><i data-lucide="x-circle" width="20"></i></button>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                `;
            }
            else if (state.view === 'translation') {
                html = `
                    <div class="max-w-3xl mx-auto space-y-8 fade-in">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-slate-800 mb-2">Translation Arena</h2>
                            <p class="text-slate-500">Target Level: C1</p>
                        </div>
                        ${!state.transPrompt ? `
                            <div class="flex justify-center">
                                <button onclick="handleTranslationStart()" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-8 py-4 text-lg rounded-xl font-bold shadow-xl btn-press">Start New Challenge</button>
                            </div>
                        ` : `
                            <div class="space-y-6">
                                <div class="bg-slate-900 text-white p-8 rounded-2xl relative overflow-hidden shadow-lg">
                                    <span class="bg-purple-500/20 text-purple-200 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider mb-4 inline-block">${state.transPrompt.context}</span>
                                    <p class="text-2xl font-serif leading-relaxed">"${state.transPrompt.text}"</p>
                                </div>
                                <div class="relative">
                                    <textarea id="trans-area" class="w-full p-6 h-40 rounded-2xl border-2 border-slate-200 focus:border-indigo-500 focus:ring-0 outline-none transition-all text-lg resize-none shadow-sm" placeholder="Type translation here..." oninput="state.transInput=this.value">${state.transInput}</textarea>
                                    <div class="absolute bottom-4 right-4">
                                        <button onclick="handleTranslationCheck()" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-4 py-2 rounded-xl font-bold shadow-lg btn-press flex items-center gap-2">
                                            Submit <i data-lucide="arrow-right" width="18"></i>
                                        </button>
                                    </div>
                                </div>
                                ${state.transFeedback ? `
                                    <div class="p-6 rounded-2xl border-l-4 ${state.transFeedback.score >= 80 ? 'bg-green-50 border-green-500' : 'bg-pink-50 border-pink-500'} fade-in">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-bold text-lg">Feedback</h3>
                                            <span class="text-2xl font-black">${state.transFeedback.score}/100</span>
                                        </div>
                                        <p class="text-slate-700 leading-relaxed">${state.transFeedback.feedback}</p>
                                        <div class="mt-6 flex justify-end">
                                            <button onclick="state.transPrompt=null;state.transFeedback=null;render()" class="bg-white border-2 border-indigo-100 text-indigo-700 px-4 py-2 rounded-xl font-bold hover:bg-indigo-50">Next</button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `}
                    </div>
                `;
            }
            else if (state.view === 'chat') {
                html = `
                    <div class="h-[calc(100vh-8rem)] flex flex-col bg-white rounded-2xl shadow-xl overflow-hidden fade-in border border-slate-200">
                        <div class="bg-indigo-50 p-4 border-b border-indigo-100 flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-xl">‚òï</div>
                            <div>
                                <h3 class="font-bold text-indigo-900">German Bestie</h3>
                                <p class="text-xs text-indigo-600">No strict grammar allowed!</p>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50" id="chat-container">
                            ${state.chatHistory.map(msg => `
                                <div class="flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'}">
                                    <div class="max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border border-slate-200 text-slate-700 rounded-bl-none shadow-sm'}">
                                        ${msg.text}
                                        ${msg.role === 'assistant' ? `<button onclick="speak('${msg.text.replace(/'/g, "\\'")}')" class="ml-2 inline-block opacity-50 hover:opacity-100 align-bottom"><i data-lucide="volume-2" width="14"></i></button>` : ''}
                                    </div>
                                    ${msg.correction ? `<div class="mt-1 mr-1 text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded-md border border-amber-100 flex items-center gap-1"><i data-lucide="sparkles" width="10"></i> Tip: ${msg.correction}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        <div class="p-4 bg-white border-t border-slate-100 flex gap-2">
                            <input id="chat-input" type="text" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Schreib etwas..." onkeydown="if(event.key==='Enter') handleChatSend()">
                            <button onclick="handleChatSend()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold btn-press">Send</button>
                        </div>
                    </div>
                `;
            }
            else if (state.view === 'settings') {
                html = `
                    <div class="max-w-xl mx-auto space-y-6 fade-in">
                        <h2 class="text-2xl font-bold mb-6">Settings</h2>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h3 class="font-bold text-lg mb-4">Connection</h3>
                            <label class="block text-sm font-medium text-slate-600 mb-2">Gemini API Key</label>
                            <input type="password" class="w-full p-3 border border-slate-200 rounded-xl mb-2" value="${state.apiKey}" oninput="state.apiKey=this.value;saveState()" placeholder="Paste key here...">
                            <p class="text-xs text-slate-400">Required for AI features.</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h3 class="font-bold text-lg mb-4">Personalization</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-2">Her Name</label>
                                    <input type="text" class="w-full p-3 border border-slate-200 rounded-xl" value="${state.customName}" oninput="state.customName=this.value;saveState()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 mb-2">Cheer Message</label>
                                    <input type="text" class="w-full p-3 border border-slate-200 rounded-xl" value="${state.cheerMessage}" oninput="state.cheerMessage=this.value;saveState()">
                                </div>
                            </div>
                        </div>
                        <div class="text-center pt-8">
                            <p class="text-slate-400 text-sm">Created with ‚ù§Ô∏è by Alaa for his linguistic genius.</p>
                        </div>
                    </div>
                `;
            }

            root.innerHTML = html;
            lucide.createIcons();
            
            // Auto scroll chat
            if(state.view === 'chat') {
                const c = document.getElementById('chat-container');
                if(c) c.scrollTop = c.scrollHeight;
            }
        }

        // --- INIT ---
        render();
        updateUI();
    </script>
</body>
</html>